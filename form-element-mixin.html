<script>
  /**
   * mixin to extend an element, to be compatible with iron-form
   *
   * @mixinFunction
   * @polymer
   */
  const FormElementMixin = (superClass) => { // eslint-disable-line no-unused-vars

    return class extends superClass {

      static get properties() {
        return {
          /**
           * name of the input
           */
          name: {
            type: String
          },

          /**
           * description for the element and can be used as a hint for invalid values
           */
          title: {
            type: String,
            reflectToAttribute: true,
          },

          /**
           * disables the input
           */
          disabled: {
            type: Boolean,
            reflectToAttribute: true,
            notify: true
          },

          /**
           * required attribute
           */
          required: {
            type: Boolean,
            reflectToAttribute: true,
            notify: true
          },

          /**
           * defines the property that should be used for the value
           */
          propertyForValue: {
            type: String,
            observer: '_createReflectPropertyToValueObserver'
          },

          /**
           * required attribute
           */
          invalid: {
            type: Boolean,
            readOnly: true,
            reflectToAttribute: true,
            notify: true,
            value: false
          },

          /**
           * is true when the value is not undefined
           */
          _valueIsSet: {
            type: Boolean,
            readOnly: true,
            value: false
          },

          /**
           * default value of the value, when it does not validate
           */
          default: {
            type: Object,
            observer: '_defaultChanged'
          },

          /**
           * value of the input
           */
          value: {
            type: Object,
            notify: true
          }
        }
      }

      static get observers() {
        return [
          '_computeInvalid(value, required)',
          '_computeValueIsSet(value)',
          '_valueChanged(value)'
        ]
      }

      /**
       * attach dom with `delegatesFocus: true` so that the element is also focussed while its's children are too, and to autofocus to first tabable
       */
      _attachDom(dom) {
        if (!this.shadowRoot) {
          this.attachShadow({
              mode: 'open',
              delegatesFocus: true
          });
          this.shadowRoot.appendChild(dom);
        }
        return this.shadowRoot;
      }

      connectedCallback() {
        super.connectedCallback();
        this._ensureAttribute('tabindex', 0);
      }

      /**
       * validates the input for iron-form
       */
      validate() {
        return !this.invalid;
      }

      /**
       * defines whether the value is set
       * @param  {[Object]} value
       */
      _computeInvalid(value) {
        this._setInvalid(!this._validate(value));
      }

      /**
       * @overwrite
       * validate a value (when required)
       * @param  {Object} value      value to validate
       * @param  {Boolean} required  whether the value is required
       * @return {Boolean}           true, if the value is valid
       */
      _validate(value) {
        return Boolean(!this.required || this._isSet(value));
      }

      /**
       * defines whether the value is set
       * @param  {[Object]} value
       */
      _computeValueIsSet(value) {
        this._set_valueIsSet(this._isSet(value));
      }

      /**
       * @overwrite
       * defines wheather a value is set correctly
       * @param  {Object} value      value to test
       * @return {Boolean}           true, if the value is set
       */
      _isSet(value) {
        return !(value === undefined || value === null || value === '');
      }

      _valueChanged(value) {
        // test if value is set and if needed set value to default
        if (this._isSet(value) === false && this.default !== undefined) {
          this.value = this.default;
        }
      }

      _defaultChanged(def) {
        if (this._isSet(def) === false) {
          this.default = '';
        }
        if (this._isSet(this.value) === false) {
          // set value to default
          this.value = this.default ;
        }
      }

      _createReflectPropertyToValueObserver(prop) {
        if (prop !== undefined) {
          this._createPropertyObserver(prop, '_reflectPropertyToValue');
          this._createPropertyObserver('value', '_reflectValueToProperty');
          if (this._isSet(this[prop])) {
            this.set('value', this[prop]);
          } else if (this._isSet(this.value)) {
            this.set(prop, this.value);
          }
        }
      }

      _reflectPropertyToValue() {
        this.set('value', this[this.propertyForValue]);
      }

      _reflectValueToProperty(value) {
        this.set(this.propertyForValue, value);
      }
    }
  }

  window.FormElementMixin = FormElementMixin;
</script>
